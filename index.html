<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Radar Ponto - Biometria Facial</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --danger: #dc2626; --warning: #f59e0b; --bg: #f1f5f9; --text: #1e293b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; color: var(--text); }
        .container { display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px; box-sizing: border-box; }
        .card { background: white; padding: 1.5rem; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 400px; text-align: center; }
        .hidden { display: none !important; }
        
        #video-container { position: relative; width: 100%; aspect-ratio: 4/3; background: #000; border-radius: 12px; overflow: hidden; margin: 15px 0; border: 4px solid transparent; transition: 0.3s; }
        .detecting { border-color: var(--primary) !important; }
        .success-border { border-color: var(--success) !important; }
        video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        .main-clock { font-size: 3rem; font-weight: bold; margin: 10px 0; color: var(--primary); }
        button { width: 100%; padding: 15px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; margin-bottom: 10px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }

        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-top: 10px; }
        th, td { border: 1px solid #000; padding: 6px; text-align: center; }
        .signature-container { display: none; justify-content: space-between; margin-top: 40px; }
        .sig-box { border-top: 1px solid #000; width: 45%; font-size: 10px; font-weight: bold; padding-top: 5px; }

        @media print {
            .no-print { display: none !important; }
            .relatorio-func { page-break-after: always; padding: 20px; background: white; }
            .signature-container { display: flex !important; }
        }
    </style>
</head>
<body>

<div class="container no-print" id="app">
    <div id="loading" class="card">
        <h3>Radar Comercial</h3>
        <p>Iniciando Biometria...</p>
    </div>

    <div id="main-card" class="card hidden">
        <h2>Radar Comercial</h2>
        <div id="relogio" class="main-clock">00:00:00</div>
        
        <div id="video-container" class="hidden">
            <video id="video" autoplay muted playsinline></video>
        </div>
        
        <p id="status-ia" style="font-weight: bold;">Pronto para registrar</p>
        
        <button id="btn-auth" class="btn-primary" onclick="iniciarValidacao()">ABRIR C√ÇMERA (BATER PONTO)</button>
        <button id="btn-adm" class="btn-primary" style="background:#6366f1" onclick="abrirGestao()">GEST√ÉO ADM</button>
    </div>
</div>

<div id="admin-area" class="container hidden">
    <div class="card no-print">
        <h3>Painel de Gest√£o</h3>
        <button class="btn-primary" onclick="window.print()">üñ®Ô∏è Imprimir Folhas</button>
        <button class="btn-danger" onclick="fecharGestao()">Voltar</button>
    </div>
    <div id="relatorio-conteudo" style="width: 100%; background: white;"></div>
</div>

<script>
    let faceMatcher = null;
    let validando = false;
    const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';

    async function init() {
        try {
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
            await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
            
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('main-card').classList.remove('hidden');
            atualizarRelogio();
            setInterval(atualizarRelogio, 1000);
            treinarIA();
        } catch (e) {
            document.getElementById('loading').innerText = "Erro ao carregar modelos.";
        }
    }

    function atualizarRelogio() {
        document.getElementById('relogio').innerText = new Date().toLocaleTimeString('pt-BR');
    }

    function treinarIA() {
        const faces = JSON.parse(localStorage.getItem('radar_biometria') || '{}');
        const descriptors = Object.keys(faces).map(nome => {
            return new faceapi.LabeledFaceDescriptors(nome, [new Float32Array(faces[nome])]);
        });
        if (descriptors.length > 0) {
            faceMatcher = new faceapi.FaceMatcher(descriptors, 0.6);
        }
    }

    async function iniciarValidacao() {
        if(validando) return;
        
        document.getElementById('video-container').classList.remove('hidden');
        document.getElementById('video-container').classList.add('detecting');
        document.getElementById('btn-auth').classList.add('hidden');
        document.getElementById('status-ia').innerText = "Aproxime seu rosto...";

        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
        const video = document.getElementById('video');
        video.srcObject = stream;

        validando = true;

        const loop = setInterval(async () => {
            const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                .withFaceLandmarks()
                .withFaceDescriptor();

            if (detection) {
                if (!faceMatcher) {
                    const nome = prompt("Primeiro acesso. Digite seu nome:");
                    if (nome) {
                        const banco = JSON.parse(localStorage.getItem('radar_biometria') || '{}');
                        banco[nome] = Array.from(detection.descriptor);
                        localStorage.setItem('radar_biometria', JSON.stringify(banco));
                        location.reload();
                    }
                    pararCamera(stream, loop);
                } else {
                    const match = faceMatcher.findBestMatch(detection.descriptor);
                    if (match.label !== 'unknown') {
                        document.getElementById('video-container').classList.replace('detecting', 'success-border');
                        document.getElementById('status-ia').innerHTML = `<b style="color:green">Identificado: ${match.label}</b>`;
                        
                        // REGISTRO AUTOM√ÅTICO
                        clearInterval(loop);
                        setTimeout(() => {
                            confirmarBatida(match.label);
                            pararCamera(stream, null);
                        }, 500);
                    }
                }
            }
        }, 600);
    }

    function pararCamera(stream, loop) {
        if(loop) clearInterval(loop);
        stream.getTracks().forEach(t => t.stop());
        document.getElementById('video-container').classList.add('hidden');
        validando = false;
    }

    function confirmarBatida(nome) {
        let pontos = JSON.parse(localStorage.getItem('radar_pontos') || '[]');
        const hoje = new Date().toLocaleDateString('pt-BR');
        
        // TRAVA DE 4 BATIDAS
        const batidasHoje = pontos.filter(p => p.nome === nome && p.data === hoje).length;
        
        if (batidasHoje >= 4) {
            alert(`Limite di√°rio atingido! ${nome} j√° possui 4 registros hoje.`);
            location.reload();
            return;
        }

        const agora = new Date();
        pontos.push({
            nome: nome,
            data: hoje,
            hora: agora.toLocaleTimeString('pt-BR').substring(0, 5)
        });
        
        localStorage.setItem('radar_pontos', JSON.stringify(pontos));
        alert(`Ponto registrado automaticamente: ${nome}\nBatida ${batidasHoje + 1} de 4`);
        location.reload();
    }

    function abrirGestao() {
        const senha = prompt("Senha ADM:");
        if (senha !== 'radar2025') return alert("Acesso negado");
        document.getElementById('app').classList.add('hidden');
        document.getElementById('admin-area').classList.remove('hidden');
        renderizarRelatorio();
    }

    function fecharGestao() {
        document.getElementById('app').classList.remove('hidden');
        document.getElementById('admin-area').classList.add('hidden');
    }

    function renderizarRelatorio() {
        const pontos = JSON.parse(localStorage.getItem('radar_pontos') || '[]');
        const biometria = JSON.parse(localStorage.getItem('radar_biometria') || '{}');
        const nomes = Object.keys(biometria);
        
        let html = '';
        nomes.forEach(nome => {
            html += `<div class="relatorio-func">
                <center><h2>RADAR COMERCIAL</h2><p>Relat√≥rio Individual: ${nome}</p></center>
                <table>
                    <thead><tr><th>Data</th><th>ENTRADA</th><th>ALMO√áO</th><th>V. ALMO√áO</th><th>SA√çDA</th></tr></thead>
                    <tbody>`;
            
            const meusPontos = pontos.filter(p => p.nome === nome);
            const dias = [...new Set(meusPontos.map(p => p.data))].sort();
            
            dias.forEach(dia => {
                const pDia = meusPontos.filter(p => p.data === dia).sort((a,b) => a.hora.localeCompare(b.hora));
                html += `<tr><td>${dia}</td><td>${pDia[0]?.hora || '-'}</td><td>${pDia[1]?.hora || '-'}</td><td>${pDia[2]?.hora || '-'}</td><td>${pDia[3]?.hora || '-'}</td></tr>`;
            });

            html += `</tbody></table>
                <div class="signature-container">
                    <div class="sig-box">Assinatura do Colaborador</div>
                    <div class="sig-box">Assinatura da Empresa</div>
                </div>
            </div>`;
        });
        document.getElementById('relatorio-conteudo').innerHTML = html || '<p>Nenhum registro encontrado.</p>';
    }

    init();
</script>
</body>
</html>
