<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Radar Ponto - Biometria e Holerite</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root { --primary: #003366; --success: #16a34a; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; }
        .container { display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 15px; box-sizing: border-box; }
        .card { background: white; width: 100%; max-width: 600px; padding: 20px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        
        /* Elementos Visuais */
        .logo-box { border: 2px solid var(--primary); border-radius: 10px; padding: 10px; margin-bottom: 15px; min-height: 60px; display: flex; align-items: center; justify-content: center; }
        .logo-box img { max-height: 80px; }
        .clock-box { background: #1e293b; color: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; }
        .time { font-size: 3.5rem; font-weight: 800; }
        #video-container { width: 100%; border-radius: 20px; overflow: hidden; background: #000; aspect-ratio: 4/3; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        button { padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-red { background: #dc2626; color: white; }
        .hidden { display: none !important; }

        /* Estilo do Holerite para Impress√£o */
        @media print {
            .no-print, button, input, .logo-box, .clock-box, #video-container { display: none !important; }
            .page-break { page-break-after: always; color: black; padding: 20px; }
            .holerite-box { border: 2px solid #000; padding: 20px; margin-bottom: 50px; }
            table { width: 100%; border-collapse: collapse; margin: 15px 0; }
            th, td { border: 1px solid #000; padding: 10px; text-align: left; }
        }
    </style>
</head>
<body>

<div id="lock-screen" class="hidden">...</div> <div class="container" id="screen-totem">
    <div class="card">
        <div id="display-logo" class="logo-box"></div>
        <div class="clock-box"><div class="time" id="txt-time">00:00:00</div></div>
        <div id="video-container"><video id="video" autoplay muted playsinline></video></div>
        <button class="btn-red" onclick="processarAcao()">REGISTRAR PONTO</button>
        <a href="javascript:void(0)" onclick="abrirPainelEmpresa()" style="display:block; margin-top:15px; color:gray;">Painel ADM</a>
    </div>
</div>

<div class="container hidden" id="screen-adm">
    <div class="card" style="max-width: 800px;">
        <button class="btn-red" onclick="location.reload()">‚¨Ö Voltar</button>
        <h3>Painel Administrativo</h3>
        <input type="month" id="filtro-mes">
        <div style="display:flex; gap:10px;">
            <button class="btn-primary" onclick="gerarRelatorio()">üìä Folha de Ponto</button>
            <button class="btn-success" onclick="gerarHolerite()">üí∞ Gerar Holerites</button>
        </div>
        <button class="btn-primary" style="background:#6366f1" onclick="window.print()">üñ®Ô∏è Imprimir PDF</button>
        <hr>
        <button class="btn-success" onclick="entrarModoCadastro()">+ Cadastrar Funcion√°rio</button>
        <div id="box-relatorio" style="text-align: left; margin-top:20px;"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, setDoc, doc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // CONFIGURA√á√ÉO FIREBASE (Mantenha as suas chaves aqui)
    const firebaseConfig = { apiKey: "AIzaSyBRTIODyEYkXMgR5gDbEq2Q62wZ7mgReL8", authDomain: "radar-ponto.firebaseapp.com", projectId: "radar-ponto", storageBucket: "radar-ponto.appspot.com", appId: "1:957045066994:web:740afa605071c69e3ed46b" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const params = new URLSearchParams(window.location.search);
    const empresaID = params.get('id');

    let configEmpresa = null;
    let modoCadastro = false;

    async function init() {
        const snap = await getDoc(doc(db, "configuracoes_mestre", empresaID));
        if (snap.exists()) {
            configEmpresa = snap.data();
            document.getElementById('display-logo').innerHTML = `<h2>${configEmpresa.nome}</h2>`;
            ligarCamera();
        }
    }

    // --- CADASTRO COM SAL√ÅRIO ---
    window.entrarModoCadastro = () => {
        modoCadastro = true;
        document.getElementById('screen-adm').classList.add('hidden');
        document.getElementById('screen-totem').classList.remove('hidden');
        alert("Aponte para a c√¢mera e clique em capturar para cadastrar.");
    };

    window.processarAcao = async () => {
        const video = document.getElementById('video');
        const det = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
        
        if(modoCadastro) {
            const nome = prompt("Nome do Funcion√°rio:");
            const valorHora = prompt("Valor da Hora (Ex: 25.50):");
            if(nome && valorHora) {
                await setDoc(doc(db, `empresas/${empresaID}/biometria`, nome), { 
                    descriptor: Array.from(det.descriptor),
                    valorHora: parseFloat(valorHora)
                });
                alert("Cadastrado!"); location.reload();
            }
        } else {
            // L√≥gica de bater ponto (simplificada para o exemplo)
            alert("Ponto registrado com sucesso!");
        }
    };

    // --- GERADOR DE HOLERITE ---
    window.gerarHolerite = async () => {
        const mesSel = document.getElementById('filtro-mes').value;
        const [ano, mes] = mesSel.split('-');
        
        const ptsSnap = await getDocs(collection(db, `empresas/${empresaID}/pontos`));
        const funcSnap = await getDocs(collection(db, `empresas/${empresaID}/biometria`));
        
        let todosPontos = [];
        ptsSnap.forEach(d => { if(d.data().data.includes(`/${mes}/${ano}`)) todosPontos.push(d.data()); });

        let htmlFinal = "";
        
        funcSnap.forEach(fDoc => {
            const f = fDoc.data();
            const nome = fDoc.id;
            const valorHora = f.valorHora || 0;
            
            // C√°lculo de Horas
            let totalMins = 0;
            const meusPontos = todosPontos.filter(p => p.nome === nome).sort((a,b) => a.timestamp - b.timestamp);
            
            for(let i=0; i < meusPontos.length-1; i+=2) {
                const [h1, m1] = meusPontos[i].hora.split(':').map(Number);
                const [h2, m2] = meusPontos[i+1].hora.split(':').map(Number);
                totalMins += (h2 * 60 + m2) - (h1 * 60 + m1);
            }

            const totalHoras = totalMins / 60;
            const totalPagar = totalHoras * valorHora;

            htmlFinal += `
                <div class="page-break">
                    <div class="holerite-box">
                        <center>
                            <h2 style="margin:0">${configEmpresa.nome}</h2>
                            <p>RECIBO DE PAGAMENTO DE SAL√ÅRIO - M√äS: ${mes}/${ano}</p>
                        </center>
                        <hr>
                        <p><b>FUNCION√ÅRIO:</b> ${nome.toUpperCase()}</p>
                        <table>
                            <tr><th>Descri√ß√£o</th><th>Refer√™ncia</th><th>Vencimentos</th></tr>
                            <tr>
                                <td>Horas Trabalhadas (Biometria)</td>
                                <td>${totalHoras.toFixed(2)} horas</td>
                                <td>R$ ${totalPagar.toFixed(2)}</td>
                            </tr>
                            <tr style="font-weight:bold;">
                                <td colspan="2" align="right">VALOR L√çQUIDO A RECEBER:</td>
                                <td>R$ ${totalPagar.toFixed(2)}</td>
                            </tr>
                        </table>
                        <p style="font-size:12px; margin-top:30px;">
                            Declaro ter recebido a import√¢ncia l√≠quida discriminada neste recibo.
                        </p>
                        <br><br>
                        <center>__________________________________________<br>Assinatura do Funcion√°rio</center>
                    </div>
                </div>`;
        });
        
        document.getElementById('box-relatorio').innerHTML = htmlFinal;
    };

    // Inicializa√ß√£o da c√¢mera e rel√≥gio... (Manter as fun√ß√µes anteriores)
    setInterval(() => { document.getElementById('txt-time').innerText = new Date().toLocaleTimeString('pt-BR'); }, 1000);
    init();

</script>
</body>
</html>
