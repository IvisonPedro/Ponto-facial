<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Radar Ponto</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root { --primary: #003366; --bg: #f8fafc; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; text-align: center; }
        .container { display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .card { background: white; width: 100%; max-width: 500px; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        #video { width: 100%; border-radius: 15px; background: #000; transform: scaleX(-1); }
        button { padding: 15px; width: 100%; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-red { background: #dc2626; color: white; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
    </style>
</head>
<body>

<div id="loading" style="padding: 50px;">
    <h2>Carregando Radar...</h2>
</div>

<div id="screen-lock" class="container hidden">
    <div class="card">
        <h3>üõ°Ô∏è Painel de Revenda</h3>
        <input type="password" id="pass-mestre" placeholder="Senha Mestra">
        <button class="btn-blue" onclick="entrarRevenda()">ACESSAR PAINEL</button>
    </div>
</div>

<div id="screen-mestre" class="container hidden">
    <div class="card">
        <h3>Nova Empresa (Cole√ß√£o: radar)</h3>
        <input id="new-id" placeholder="ID (ex: radar)">
        <input id="new-nome" placeholder="Nome da Empresa">
        <input id="new-senha" placeholder="Senha ADM">
        <input type="color" id="new-cor" value="#003366" style="height:50px">
        <button class="btn-blue" onclick="salvarEmpresa()">SALVAR NO BANCO</button>
        <button class="btn-red" onclick="location.reload()">SAIR</button>
    </div>
</div>

<div id="screen-totem" class="container hidden">
    <div class="card">
        <div id="logo-empresa" style="margin-bottom:15px; font-weight:bold; font-size:20px;"></div>
        <div style="font-size: 2rem; font-weight: bold; margin-bottom: 15px;" id="relogio">00:00:00</div>
        <video id="video" autoplay muted playsinline></video>
        <p id="msg">Iniciando Biometria...</p>
        <button class="btn-blue" onclick="baterPonto()">REGISTRAR PONTO</button>
        <button class="btn-red" style="margin-top:20px; font-size:12px;" onclick="admEmpresa()">PAINEL ADM</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, collection } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBRTIODyEYkXMgR5gDbEq2Q62wZ7mgReL8",
        authDomain: "radar-ponto.firebaseapp.com",
        projectId: "radar-ponto",
        storageBucket: "radar-ponto.appspot.com",
        appId: "1:957045066994:web:740afa605071c69e3ed46b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const params = new URLSearchParams(window.location.search);
    const empresaID = params.get('id')?.toLowerCase().trim();

    async function init() {
        if (!empresaID) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('screen-lock').classList.remove('hidden');
            return;
        }

        try {
            // BUSCA NA COLE√á√ÉO "radar"
            const snap = await getDoc(doc(db, "radar", empresaID));

            if (snap.exists()) {
                window.dadosEmpresa = snap.data();
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('screen-totem').classList.remove('hidden');
                document.getElementById('logo-empresa').innerText = window.dadosEmpresa.nome;
                document.documentElement.style.setProperty('--primary', window.dadosEmpresa.cor);
                abrirCamera();
            } else {
                alert("EMPRESA N√ÉO ENCONTRADA!\nO ID '" + empresaID + "' n√£o existe na cole√ß√£o 'radar'.");
                window.location.href = window.location.origin + window.location.pathname;
            }
        } catch (e) {
            alert("ERRO DE CONEX√ÉO: Verifique as regras do seu Firebase.");
            console.error(e);
        }
    }

    window.entrarRevenda = () => {
        if(document.getElementById('pass-mestre').value === "9988") {
            document.getElementById('screen-lock').classList.add('hidden');
            document.getElementById('screen-mestre').classList.remove('hidden');
        } else { alert("Senha incorreta"); }
    };

    window.salvarEmpresa = async () => {
        const id = document.getElementById('new-id').value.toLowerCase().trim();
        if(!id) return alert("Digite um ID");
        await setDoc(doc(db, "radar", id), {
            nome: document.getElementById('new-nome').value,
            senha: document.getElementById('new-senha').value,
            cor: document.getElementById('new-cor').value
        });
        alert("Empresa cadastrada! Acesse: " + window.location.origin + window.location.pathname + "?id=" + id);
    };

    async function abrirCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        document.getElementById('video').srcObject = stream;
        document.getElementById('msg').innerText = "C√¢mera Ativa";
    }

    setInterval(() => {
        document.getElementById('relogio').innerText = new Date().toLocaleTimeString('pt-BR');
    }, 1000);

    init();
</script>
</body>
</html>
