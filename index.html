<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Radar Ponto - Gest√£o</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root { --primary: #003366; --success: #16a34a; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; color: #1e293b; }
        .container { display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 15px; box-sizing: border-box; }
        .card { background: white; width: 100%; max-width: 600px; padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        .logo-text { font-size: 24px; font-weight: 900; color: var(--primary); border: 3px solid var(--primary); padding: 10px; border-radius: 12px; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; }
        .logo-text img { max-height: 60px; }
        .time { font-size: 3rem; font-weight: 800; font-family: monospace; margin: 10px 0; }
        #video-container { width: 100%; border-radius: 20px; overflow: hidden; margin: 10px 0; background: #000; aspect-ratio: 4/3; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; }
        button { padding: 18px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; font-size: 16px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .hidden { display: none !important; }
        .revenda-box { text-align: left; width: 100%; }
        .item-cliente { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; align-items: center; }
        #lock-screen { background: var(--primary); color: white; display: flex; justify-content: center; align-items: center; height: 100vh; width: 100%; position: fixed; z-index: 999; }
    </style>
</head>
<body>

<div id="lock-screen">
    <div class="card" style="max-width: 350px; color: #333;">
        <h3>üõ°Ô∏è Acesso Restrito</h3>
        <p>Introduza a Senha Mestra para gerir a revenda:</p>
        <input type="password" id="master-pass" placeholder="****" style="text-align: center; font-size: 20px;">
        <button class="btn-primary" onclick="verificarSenhaMestra()">ENTRAR NO PAINEL</button>
    </div>
</div>

<div class="container hidden" id="screen-mestre">
    <div class="card">
        <div class="logo-text">üõ°Ô∏è PAINEL DE REVENDA</div>
        <div class="revenda-box">
            <p><b>Cadastrar Novo Cliente:</b></p>
            <input id="m-id" placeholder="ID da URL (ex: padaria)">
            <input id="m-nome" placeholder="Nome da Empresa">
            <input id="m-senha" placeholder="Senha Administrativa do Cliente">
            <input type="color" id="m-cor" value="#003366" style="height:45px">
            <input id="m-logo" placeholder="URL do Logo (PNG)">
            <button class="btn-success" onclick="salvarCliente()">CADASTRAR EMPRESA</button>
            <hr>
            <div id="m-lista">A carregar clientes...</div>
        </div>
    </div>
</div>

<div class="container hidden" id="screen-main">
    <div class="card">
        <div id="display-logo" class="logo-text">CARREGANDO...</div>
        <div class="time" id="txt-time">00:00:00</div>
        <div id="video-container"><video id="video" autoplay muted playsinline></video></div>
        <div id="status-msg" style="font-weight:bold">A iniciar...</div>
        <button class="btn-primary" onclick="registrarPonto()">REGISTRAR MEU PONTO</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, setDoc, doc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBRTIODyEYkXMgR5gDbEq2Q62wZ7mgReL8",
        authDomain: "radar-ponto.firebaseapp.com",
        projectId: "radar-ponto",
        storageBucket: "radar-ponto.appspot.com",
        appId: "1:957045066994:web:740afa605071c69e3ed46b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const params = new URLSearchParams(window.location.search);
    const empresaID = params.get('id');
    const SENHA_MESTRA_DEFINIDA = "9988"; // ALTERE AQUI A SUA SENHA DE ACESSO

    async function init() {
        // Se houver ID na URL, ignora o bloqueio mestre e vai para o totem do cliente
        if (empresaID) {
            document.getElementById('lock-screen').classList.add('hidden');
            carregarTotemCliente();
            return;
        }
        // Se n√£o houver ID, a tela de bloqueio (lock-screen) permanece vis√≠vel por padr√£o
    }

    window.verificarSenhaMestra = () => {
        const pass = document.getElementById('master-pass').value;
        if (pass === SENHA_MESTRA_DEFINIDA) {
            document.getElementById('lock-screen').classList.add('hidden');
            document.getElementById('screen-mestre').classList.remove('hidden');
            listarClientes();
        } else {
            alert("Senha Incorreta!");
        }
    };

    async function carregarTotemCliente() {
        const snap = await getDoc(doc(db, "configuracoes_mestre", empresaID));
        if (snap.exists()) {
            const config = snap.data();
            document.documentElement.style.setProperty('--primary', config.cor);
            document.getElementById('display-logo').innerHTML = config.logo ? `<img src="${config.logo}">` : config.nome;
            document.getElementById('screen-main').classList.remove('hidden');
            ligarCamera();
        } else {
            alert("Empresa n√£o encontrada.");
            window.location.href = "index.html";
        }
    }

    // --- L√ìGICA DE REVENDA ---
    window.salvarCliente = async () => {
        const id = document.getElementById('m-id').value.toLowerCase().trim();
        const dados = {
            nome: document.getElementById('m-nome').value,
            senha: document.getElementById('m-senha').value,
            cor: document.getElementById('m-cor').value,
            logo: document.getElementById('m-logo').value
        };
        if(!id || !dados.nome) return alert("Preencha o ID e Nome");
        await setDoc(doc(db, "configuracoes_mestre", id), dados);
        alert("Cliente criado com sucesso!");
        listarClientes();
    };

    async function listarClientes() {
        const s = await getDocs(collection(db, "configuracoes_mestre"));
        let h = "<b>Empresas Ativas:</b><br>";
        s.forEach(d => {
            h += `<div class="item-cliente">
                <div>
                    <b>${d.data().nome}</b><br>
                    <small style="color:blue; cursor:pointer" onclick="window.open('?id=${d.id}')">Abrir Totem: ?id=${d.id}</small>
                </div>
                <button onclick="window.excluir('${d.id}')" style="width:auto; padding:5px 10px; background:red; color:white;">X</button>
            </div>`;
        });
        document.getElementById('m-lista').innerHTML = h;
    }

    window.excluir = async (id) => { if(confirm("Eliminar empresa?")) { await deleteDoc(doc(db, "configuracoes_mestre", id)); listarClientes(); }};

    // --- L√ìGICA DO TOTEM ---
    async function ligarCamera() {
        try {
            await faceapi.nets.tinyFaceDetector.loadFromUri('https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights');
            await faceapi.nets.faceLandmark68Net.loadFromUri('https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights');
            await faceapi.nets.faceRecognitionNet.loadFromUri('https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights');
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            document.getElementById('video').srcObject = stream;
            document.getElementById('status-msg').innerText = "C√¢mera Pronta";
        } catch (e) { document.getElementById('status-msg').innerText = "Erro na c√¢mera"; }
    }

    setInterval(() => { document.getElementById('txt-time').innerText = new Date().toLocaleTimeString('pt-BR'); }, 1000);
    init();
</script>
</body>
</html>
