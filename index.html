<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Radar Ponto - Sistema Biom√©trico</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root { --primary: #003366; --success: #16a34a; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; color: #1e293b; }
        .container { display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 15px; box-sizing: border-box; }
        .card { background: white; width: 100%; max-width: 700px; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); text-align: center; }
        .logo-text { font-size: 24px; font-weight: 900; color: var(--primary); border: 3px solid var(--primary); padding: 10px; border-radius: 8px; margin-bottom: 15px; min-height: 50px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .logo-text img { max-height: 60px; max-width: 100%; object-fit: contain; }
        .time { font-size: 2.8rem; font-weight: 800; font-family: monospace; color: #1e293b; margin: 10px 0; }
        #video-container { width: 100%; border-radius: 15px; overflow: hidden; margin: 15px 0; background: #000; position: relative; }
        video { width: 100%; display: block; transform: scaleX(-1); }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button { padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .hidden { display: none !important; }
        
        /* Estilos de Relat√≥rio */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; background: white; }
        th, td { border: 1px solid #cbd5e1; padding: 10px; text-align: center; }
        th { background: #f1f5f9; }
        .batida-tag { display: inline-block; padding: 4px 10px; border-radius: 6px; margin: 2px; font-weight: bold; cursor: pointer; border: 1px solid transparent; }
        .tag-entrada { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .tag-saida { background: #fee2e2; color: #991b1b; border-color: #fecaca; }
        .alerta-ponto { color: #ea580c; font-size: 11px; display: block; margin-top: 5px; font-weight: bold; }

        @media print { 
            .no-print { display: none !important; } 
            body { background: white; }
            .container { display: block; padding: 0; }
            .card { box-shadow: none; max-width: 100%; border: none; }
            .page-break { page-break-after: always; border: 1px solid #000; padding: 30px; margin-bottom: 20px; }
        }
    </style>
</head>
<body>

<div class="container" id="screen-login">
    <div class="card">
        <div id="display-logo" class="logo-text">CARREGANDO...</div>
        <div class="time" id="txt-time">00:00:00</div>
        <div id="video-container"><video id="video" autoplay muted playsinline></video></div>
        <div id="status-msg">Iniciando c√¢mera...</div>
        <button class="btn-primary" id="btn-ponto" onclick="iniciarLeitura(false)">REGISTRAR MEU PONTO</button>
        <button style="background:none; color:gray; font-size:12px; text-decoration:underline;" onclick="verificarAcessoAdm()">Painel Administrativo</button>
    </div>
</div>

<div class="container hidden" id="screen-adm">
    <div class="card" style="max-width: 900px; text-align: left;">
        <div class="no-print" style="display: flex; justify-content: space-between; align-items: center;">
            <button class="btn-primary" style="width: auto;" onclick="location.reload()">‚¨Ö Sair</button>
            <h2 id="adm-title" style="margin: 0;">Painel de Gest√£o</h2>
        </div>

        <div class="no-print" style="background: #f1f5f9; padding: 20px; border-radius: 12px; margin: 20px 0;">
            <p style="margin-top:0;"><b>Relat√≥rios e Fechamento:</b></p>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <input type="month" id="filtro-mes" style="flex: 1; min-width: 150px;">
                <button class="btn-success" style="width: auto; flex: 1;" onclick="gerarRelatorio()">üìä VER PONTOS</button>
                <button class="btn-primary" style="width: auto; flex: 1; background: #6366f1;" onclick="gerarFechamentoIndividual()">üìÑ FECHAMENTO INDIVIDUAL</button>
            </div>
            <button class="btn-primary hidden" id="btn-print" onclick="window.print()" style="margin-top: 15px;">üñ®Ô∏è IMPRIMIR / SALVAR PDF</button>
        </div>

        <div id="relatorios-box"></div>
        <hr class="no-print">
        <div class="no-print">
            <button class="btn-success" onclick="modoCadastro()">+ CADASTRAR NOVO COLABORADOR</button>
            <div id="lista-equipe" style="margin-top: 20px;"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, setDoc, doc, onSnapshot, query, orderBy, deleteDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBRTIODyEYkXMgR5gDbEq2Q62wZ7mgReL8",
        authDomain: "radar-ponto.firebaseapp.com",
        projectId: "radar-ponto",
        storageBucket: "radar-ponto.appspot.com",
        appId: "1:957045066994:web:740afa605071c69e3ed46b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights';
    
    let empresaID = new URLSearchParams(window.location.search).get('id') || "radar";
    let configEmpresa = null;
    let faceMatcher = null;

    // INICIALIZA√á√ÉO
    async function init() {
        const snap = await getDoc(doc(db, "configuracoes_mestre", empresaID));
        if (snap.exists()) {
            configEmpresa = snap.data();
            document.documentElement.style.setProperty('--primary', configEmpresa.cor);
            const logoBox = document.getElementById('display-logo');
            logoBox.innerHTML = configEmpresa.logo ? `<img src="${configEmpresa.logo}">` : configEmpresa.nome;
            document.getElementById('adm-title').innerText = "Gest√£o: " + configEmpresa.nome;
            carregarIA();
        } else if (empresaID === "admin-mestre") { 
            iniciarPainelMestre(); // Fun√ß√£o interna de revenda
        }
    }

    async function carregarIA() {
        await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
        await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
        await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
        document.getElementById('status-msg').innerText = "C√¢mera Ativa";
        
        onSnapshot(collection(db, `empresas/${empresaID}/biometria`), (s) => {
            const desc = [];
            s.forEach(d => desc.push(new faceapi.LabeledFaceDescriptors(d.id, [new Float32Array(d.data().descriptor)])));
            faceMatcher = desc.length > 0 ? new faceapi.FaceMatcher(desc, 0.55) : null;
        });
    }

    // PONTO E BIOMETRIA
    window.iniciarLeitura = async (isCadastro) => {
        const video = document.getElementById('video');
        const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
        video.srcObject = stream;
        document.getElementById('status-msg').innerText = "Processando Rosto...";

        const check = setInterval(async () => {
            const detect = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
            if (detect) {
                clearInterval(check);
                stream.getTracks().forEach(t => t.stop());
                if (isCadastro) {
                    const nome = prompt("Nome completo do funcion√°rio:");
                    if (nome) {
                        await setDoc(doc(db, `empresas/${empresaID}/biometria`, nome), { descriptor: Array.from(detect.descriptor) });
                        alert("Cadastro realizado!");
                    }
                    location.reload();
                } else {
                    const match = faceMatcher?.findBestMatch(detect.descriptor);
                    if (match && match.label !== 'unknown') {
                        await addDoc(collection(db, `empresas/${empresaID}/pontos`), { 
                            nome: match.label, data: new Date().toLocaleDateString('pt-BR'), 
                            hora: new Date().toLocaleTimeString('pt-BR').substring(0,5), timestamp: Date.now() 
                        });
                        alert("Ponto batido: " + match.label);
                    } else alert("Rosto n√£o identificado.");
                    location.reload();
                }
            }
        }, 800);
    };

    // FUN√á√ïES ADMINISTRATIVAS E C√ÅLCULOS
    const calcDiff = (h1, h2) => {
        const [aH, aM] = h1.split(':').map(Number);
        const [bH, bM] = h2.split(':').map(Number);
        return ((bH * 60 + bM) - (aH * 60 + aM)) || 0;
    };

    window.verificarAcessoAdm = () => {
        const p = prompt("Senha Administrativa:");
        if(p === configEmpresa?.senha) {
            document.getElementById('screen-login').classList.add('hidden');
            document.getElementById('screen-adm').classList.remove('hidden');
            atualizarListaEquipe();
        }
    };

    async function atualizarListaEquipe() {
        const snap = await getDocs(collection(db, `empresas/${empresaID}/biometria`));
        let h = '<b>Funcion√°rios Ativos:</b><br>';
        snap.forEach(d => h += `<div class="batida-tag">${d.id} <span onclick="window.delFunc('${d.id}')">‚ùå</span></div>`);
        document.getElementById('lista-equipe').innerHTML = h;
    }

    window.delFunc = async (id) => { if(confirm("Remover "+id+"?")) { await deleteDoc(doc(db, `empresas/${empresaID}/biometria`, id)); atualizarListaEquipe(); }};

    window.gerarRelatorio = async () => {
        const mes = document.getElementById('filtro-mes').value;
        if(!mes) return alert("Selecione o m√™s");
        const [ano, mesNum] = mes.split('-');
        const snap = await getDocs(query(collection(db, `empresas/${empresaID}/pontos`), orderBy("timestamp", "asc")));
        const pontos = [];
        snap.forEach(d => { if(d.data().data.includes(`/${mesNum}/${ano}`)) pontos.push({id: d.id, ...d.data()}); });

        let html = `<h2>Folha de Ponto - ${mesNum}/${ano}</h2>`;
        const nomes = [...new Set(pontos.map(p => p.nome))];

        nomes.forEach(n => {
            let total = 0;
            let rows = '';
            const pUser = pontos.filter(p => p.nome === n);
            const dias = [...new Set(pUser.map(p => p.data))].sort((a,b) => a.localeCompare(b));

            dias.forEach(d => {
                const bats = pUser.filter(p => p.data === d).sort((a,b) => a.hora.localeCompare(b.hora));
                let dMin = 0;
                const tags = bats.map((b, i) => {
                    if (i % 2 !== 0) dMin += calcDiff(bats[i-1].hora, b.hora);
                    return `<span class="batida-tag ${i%2===0?'tag-entrada':'tag-saida'}" onclick="window.editPt('${b.id}','${b.hora}')">${b.hora}</span>`;
                }).join(' ');
                total += dMin;
                rows += `<tr><td>${d}</td><td>${tags}${bats.length%2!==0?'<br><small class="alerta-ponto">Sa√≠da pendente</small>':''}</td><td>${Math.floor(dMin/60)}h ${dMin%60}m</td></tr>`;
            });
            html += `<h4>${n}</h4><table><tr><th>Data</th><th>Batidas</th><th>Total</th></tr>${rows}<tr><td colspan="2"><b>SOMA MENSAL</b></td><td><b>${Math.floor(total/60)}h ${total%60}m</b></td></tr></table><br>`;
        });
        document.getElementById('relatorios-box').innerHTML = html || "Sem dados.";
        document.getElementById('btn-print').classList.remove('hidden');
    };

    window.gerarFechamentoIndividual = async () => {
        const mes = document.getElementById('filtro-mes').value;
        if(!mes) return alert("Selecione o m√™s");
        const [ano, mNum] = mes.split('-');
        const snap = await getDocs(query(collection(db, `empresas/${empresaID}/pontos`), orderBy("timestamp", "asc")));
        const pontos = [];
        snap.forEach(d => { if(d.data().data.includes(`/${mNum}/${ano}`)) pontos.push(d.data()); });

        let html = "";
        const nomes = [...new Set(pontos.map(p => p.nome))];
        nomes.forEach(n => {
            let tMin = 0;
            const pUser = pontos.filter(p => p.nome === n);
            const dias = [...new Set(pUser.map(p => p.data))].sort();
            let dRows = "";
            dias.forEach(d => {
                const bats = pUser.filter(p => p.data === d).map(b => b.hora).sort();
                let diaM = 0;
                for(let i=0; i<bats.length-1; i+=2) diaM += calcDiff(bats[i], bats[i+1]);
                tMin += diaM;
                dRows += `<tr><td>${d}</td><td>${bats.join(' | ')}</td><td>${Math.floor(diaM/60)}h ${diaM%60}m</td></tr>`;
            });

            html += `<div class="page-break">
                <h3>ESPELHO DE PONTO - ${configEmpresa.nome}</h3>
                <p><b>FUNCION√ÅRIO:</b> ${n} | <b>M√äS:</b> ${mNum}/${ano}</p>
                <table><tr><th>Data</th><th>Registros</th><th>Total</th></tr>${dRows}
                <tr style="background:#eee"><td colspan="2" align="right"><b>TOTAL GERAL</b></td><td><b>${Math.floor(tMin/60)}h ${tMin%60}m</b></td></tr></table>
                <div style="margin-top:60px; display:flex; justify-content:space-around;">
                    <div style="border-top:1px solid #000; width:200px">Empresa</div><div style="border-top:1px solid #000; width:200px">Colaborador</div>
                </div>
            </div>`;
        });
        document.getElementById('relatorios-box').innerHTML = html;
        document.getElementById('btn-print').classList.remove('hidden');
    };

    window.editPt = async (id, h) => {
        const n = prompt("Novo hor√°rio (HH:MM) ou vazio para excluir:", h);
        if(n === "") await deleteDoc(doc(db, `empresas/${empresaID}/pontos`, id));
        else if(n) await updateDoc(doc(db, `empresas/${empresaID}/pontos`, id), { hora: n });
        gerarRelatorio();
    };

    window.modoCadastro = () => { document.getElementById('screen-adm').classList.add('hidden'); document.getElementById('screen-login').classList.remove('hidden'); document.getElementById('btn-ponto').innerText = "CAPTURAR ROSTO"; document.getElementById('btn-ponto').onclick = () => iniciarLeitura(true); };

    setInterval(() => { document.getElementById('txt-time').innerText = new Date().toLocaleTimeString('pt-BR'); }, 1000);
    init();
</script>
</body>
</html>
