<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Radar Ponto">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/552/552791.png">
    <link rel="manifest" href="manifest.json">

    <title>Radar Ponto - Biometria</title>
    
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <style>
        :root { --primary: #003366; --success: #16a34a; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; color: #1e293b; overflow-x: hidden; }
        .container { display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 15px; box-sizing: border-box; }
        .card { background: white; width: 100%; max-width: 600px; padding: 20px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        .logo-text { font-size: 22px; font-weight: 900; color: var(--primary); border: 3px solid var(--primary); padding: 10px; border-radius: 12px; margin-bottom: 10px; min-height: 50px; display: flex; align-items: center; justify-content: center; }
        .logo-text img { max-height: 55px; max-width: 100%; }
        .time { font-size: 3rem; font-weight: 800; font-family: monospace; color: #1e293b; margin: 5px 0; }
        #video-container { width: 100%; border-radius: 20px; overflow: hidden; margin: 10px 0; background: #000; position: relative; aspect-ratio: 4/3; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button { padding: 18px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; font-size: 16px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .hidden { display: none !important; }
        .footer-links { margin-top: 15px; display: flex; justify-content: center; gap: 15px; }
        .link-btn { background: none; color: gray; font-size: 11px; text-decoration: underline; border: none; width: auto; padding: 5px; }
        
        /* Tabelas e Tags */
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; background: white; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #f1f5f9; }
        .batida-tag { display: inline-block; padding: 4px 8px; border-radius: 5px; margin: 2px; font-weight: bold; cursor: pointer; }
        .tag-entrada { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .tag-saida { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .alerta-ponto { color: #ea580c; font-size: 10px; display: block; font-weight: bold; }

        @media print { 
            .no-print { display: none !important; } 
            .page-break { page-break-after: always; border: 1px solid #000; padding: 30px; margin-bottom: 20px; }
        }
    </style>
</head>
<body>

<div class="container" id="screen-main">
    <div class="card">
        <div id="display-logo" class="logo-text">CARREGANDO...</div>
        <div class="time" id="txt-time">00:00:00</div>
        <div id="video-container"><video id="video" autoplay muted playsinline></video></div>
        <div id="status-msg" style="font-weight: bold; color: var(--primary);">Iniciando C√¢mera...</div>
        
        <button class="btn-primary" id="btn-ponto" onclick="registrarPonto()">REGISTRAR MEU PONTO</button>
        
        <div class="footer-links no-print">
            <button class="link-btn" onclick="abrirAdm()">Painel da Empresa</button>
            <button class="link-btn" onclick="abrirMestre()">üõ°Ô∏è Revenda</button>
        </div>
    </div>
</div>

<div class="container hidden" id="screen-adm">
    <div class="card" style="max-width: 900px; text-align: left;">
        <button class="btn-primary no-print" style="width: auto;" onclick="location.reload()">‚¨Ö Sair</button>
        <h2 id="adm-title">Gest√£o</h2>
        <div class="no-print" style="background:#f1f5f9; padding:15px; border-radius:15px;">
            <input type="month" id="filtro-mes">
            <div style="display:flex; gap:10px;">
                <button class="btn-success" onclick="gerarRelatorio()">üìä VER PONTOS</button>
                <button class="btn-primary" style="background:#6366f1;" onclick="gerarFechamento()">üìÑ FECHAMENTO</button>
            </div>
            <button class="btn-primary hidden" id="btn-print" onclick="window.print()">üñ®Ô∏è GERAR PDF</button>
        </div>
        <div id="relatorios-box"></div>
        <hr class="no-print">
        <button class="btn-success no-print" id="btn-cad-modo" onclick="ativarModoCadastro()">+ NOVO COLABORADOR</button>
        <div id="lista-equipe" class="no-print" style="margin-top:10px;"></div>
    </div>
</div>

<div class="container hidden" id="screen-mestre">
    <div class="card" style="text-align: left;">
        <button class="btn-primary" style="width: auto;" onclick="location.reload()">‚¨Ö Sair</button>
        <h2>üõ°Ô∏è Gest√£o de Clientes</h2>
        <div style="background:#f1f5f9; padding:15px; border-radius:10px;">
            <input id="m-id" placeholder="ID do Link (ex: radar)">
            <input id="m-nome" placeholder="Nome da Empresa">
            <input id="m-senha" placeholder="Senha Adm Empresa">
            <input type="color" id="m-cor" value="#003366" style="height:50px">
            <input id="m-logo" placeholder="URL da Logo (PNG)">
            <button class="btn-success" onclick="salvarCliente()">CADASTRAR CLIENTE</button>
        </div>
        <hr>
        <div id="m-lista"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, setDoc, doc, onSnapshot, query, orderBy, deleteDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBRTIODyEYkXMgR5gDbEq2Q62wZ7mgReL8",
        authDomain: "radar-ponto.firebaseapp.com",
        projectId: "radar-ponto",
        storageBucket: "radar-ponto.appspot.com",
        appId: "1:957045066994:web:740afa605071c69e3ed46b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights';
    
    let empresaID = new URLSearchParams(window.location.search).get('id') || "radar";
    let configEmpresa = null;
    let faceMatcher = null;
    let cameraIniciada = false;
    let modoCadastro = false;

    // INICIALIZA√á√ÉO
    async function init() {
        const snap = await getDoc(doc(db, "configuracoes_mestre", empresaID));
        if (snap.exists()) {
            configEmpresa = snap.data();
            document.documentElement.style.setProperty('--primary', configEmpresa.cor);
            document.getElementById('display-logo').innerHTML = configEmpresa.logo ? `<img src="${configEmpresa.logo}">` : configEmpresa.nome;
            document.getElementById('adm-title').innerText = configEmpresa.nome;
            ligarCamera();
        } else {
            document.getElementById('display-logo').innerText = "ID INV√ÅLIDO";
        }
    }

    async function ligarCamera() {
        try {
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
            await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
            
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            document.getElementById('video').srcObject = stream;
            cameraIniciada = true;
            document.getElementById('status-msg').innerText = "C√¢mera Ativa";

            onSnapshot(collection(db, `empresas/${empresaID}/biometria`), (s) => {
                const desc = [];
                s.forEach(d => desc.push(new faceapi.LabeledFaceDescriptors(d.id, [new Float32Array(d.data().descriptor)])));
                faceMatcher = desc.length > 0 ? new faceapi.FaceMatcher(desc, 0.55) : null;
            });
        } catch (e) { document.getElementById('status-msg').innerText = "Erro: Ative a c√¢mera"; }
    }

    // PONTO E CADASTRO
    window.registrarPonto = async () => {
        if(!cameraIniciada) return;
        document.getElementById('status-msg').innerText = "Processando...";
        const det = await faceapi.detectSingleFace(document.getElementById('video'), new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
        
        if (det) {
            if (modoCadastro) {
                const nome = prompt("Nome do Colaborador:");
                if(nome) await setDoc(doc(db, `empresas/${empresaID}/biometria`, nome), { descriptor: Array.from(det.descriptor) });
                alert("Cadastrado com sucesso!");
                location.reload();
            } else {
                const m = faceMatcher?.findBestMatch(det.descriptor);
                if (m && m.label !== 'unknown') {
                    await addDoc(collection(db, `empresas/${empresaID}/pontos`), { 
                        nome: m.label, 
                        data: new Date().toLocaleDateString('pt-BR'), 
                        hora: new Date().toLocaleTimeString('pt-BR').substring(0,5), 
                        timestamp: Date.now() 
                    });
                    alert("PONTO REGISTRADO: " + m.label);
                } else alert("Rosto n√£o identificado.");
            }
        } else alert("Posicione o rosto no centro.");
        document.getElementById('status-msg').innerText = "C√¢mera Ativa";
    };

    // NAVEGA√á√ÉO
    window.abrirAdm = () => { if(prompt("Senha Adm:") === configEmpresa?.senha) { document.getElementById('screen-main').classList.add('hidden'); document.getElementById('screen-adm').classList.remove('hidden'); listarEquipe(); } };
    window.abrirMestre = () => { if(prompt("Senha Mestra:") === "9988") { document.getElementById('screen-main').classList.add('hidden'); document.getElementById('screen-mestre').classList.remove('hidden'); listarClientes(); } };
    window.ativarModoCadastro = () => { modoCadastro = true; document.getElementById('screen-adm').classList.add('hidden'); document.getElementById('screen-main').classList.remove('hidden'); document.getElementById('btn-ponto').innerText = "CAPTURAR ROSTO"; document.getElementById('btn-ponto').classList.replace('btn-primary', 'btn-success'); };

    // FUN√á√ïES EMPRESA
    async function listarEquipe() {
        const s = await getDocs(collection(db, `empresas/${empresaID}/biometria`));
        let h = '<b>Colaboradores:</b><br>';
        s.forEach(d => h += `<span class="batida-tag">${d.id} <small onclick="window.delF('${d.id}')">‚ùå</small></span>`);
        document.getElementById('lista-equipe').innerHTML = h;
    }
    window.delF = async (id) => { if(confirm("Remover "+id+"?")) { await deleteDoc(doc(db, `empresas/${empresaID}/biometria`, id)); listarEquipe(); }};

    window.gerarRelatorio = async () => {
        const mes = document.getElementById('filtro-mes').value; if(!mes) return;
        const [ano, mNum] = mes.split('-');
        const snap = await getDocs(query(collection(db, `empresas/${empresaID}/pontos`), orderBy("timestamp", "asc")));
        const pts = []; snap.forEach(d => { if(d.data().data.includes(`/${mNum}/${ano}`)) pts.push({id: d.id, ...d.data()}); });
        
        let html = `<h2>Folha Mensal - ${mNum}/${ano}</h2>`;
        [...new Set(pts.map(p => p.nome))].forEach(n => {
            let t = 0; let rows = ''; const uP = pts.filter(p => p.nome === n);
            [...new Set(uP.map(p => p.data))].sort().forEach(d => {
                const b = uP.filter(p => p.data === d).sort((x,y) => x.hora.localeCompare(y.hora));
                let dM = 0; const tags = b.map((p, i) => {
                    if (i % 2 !== 0) {
                        const [h1, m1] = b[i-1].hora.split(':').map(Number); const [h2, m2] = p.hora.split(':').map(Number);
                        dM += (h2 * 60 + m2) - (h1 * 60 + m1);
                    }
                    return `<span class="batida-tag ${i%2===0?'tag-entrada':'tag-saida'}" onclick="window.edP('${p.id}','${p.hora}')">${p.hora}</span>`;
                }).join(' ');
                t += dM; rows += `<tr><td>${d}</td><td>${tags}${b.length%2!==0?'<small class="alerta-ponto">Aberto</small>':''}</td><td>${Math.floor(dM/60)}h ${dM%60}m</td></tr>`;
            });
            html += `<h4>${n}</h4><table><tr><th>Data</th><th>Batidas</th><th>Total</th></tr>${rows}<tr><td colspan="2"><b>SOMA NO M√äS</b></td><td><b>${Math.floor(t/60)}h ${t%60}m</b></td></tr></table><br>`;
        });
        document.getElementById('relatorios-box').innerHTML = html; document.getElementById('btn-print').classList.remove('hidden');
    };

    window.gerarFechamento = async () => {
        const mes = document.getElementById('filtro-mes').value; if(!mes) return;
        const [ano, mNum] = mes.split('-');
        const snap = await getDocs(query(collection(db, `empresas/${empresaID}/pontos`), orderBy("timestamp", "asc")));
        const pts = []; snap.forEach(d => { if(d.data().data.includes(`/${mNum}/${ano}`)) pts.push(d.data()); });
        let h = ""; [...new Set(pts.map(p => p.nome))].forEach(n => {
            let t = 0; const uP = pts.filter(p => p.nome === n); let dR = "";
            [...new Set(uP.map(p => p.data))].sort().forEach(d => {
                const b = uP.filter(p => p.data === d).map(x => x.hora).sort();
                let dM = 0; for(let i=0; i<b.length-1; i+=2) {
                    const [h1, m1] = b[i].split(':').map(Number); const [h2, m2] = b[i+1].split(':').map(Number);
                    dM += (h2 * 60 + m2) - (h1 * 60 + m1);
                }
                t += dM; dR += `<tr><td>${d}</td><td>${b.join(' | ')}</td><td>${Math.floor(dM/60)}h ${dM%60}m</td></tr>`;
            });
            h += `<div class="page-break"><h3>${configEmpresa.nome}</h3><p><b>COLABORADOR:</b> ${n} | <b>M√äS:</b> ${mNum}/${ano}</p><table><tr><th>Data</th><th>Registros</th><th>Total</th></tr>${dR}<tr><td colspan="2" align="right"><b>TOTAL GERAL</b></td><td><b>${Math.floor(t/60)}h ${t%60}m</b></td></tr></table><div style="margin-top:60px; display:flex; justify-content:space-around;"><div style="border-top:1px solid #000; width:200px">Empresa</div><div style="border-top:1px solid #000; width:200px">Assinatura</div></div></div>`;
        });
        document.getElementById('relatorios-box').innerHTML = h; document.getElementById('btn-print').classList.remove('hidden');
    };

    window.edP = async (id, h) => {
        const n = prompt("Novo (HH:MM) ou deixe vazio para excluir:", h);
        if(n === "") await deleteDoc(doc(db, `empresas/${empresaID}/pontos`, id));
        else if(n) await updateDoc(doc(db, `empresas/${empresaID}/pontos`, id), { hora: n });
        gerarRelatorio();
    };

    // REVENDA
    window.salvarCliente = async () => {
        const id = document.getElementById('m-id').value.toLowerCase();
        await setDoc(doc(db, "configuracoes_mestre", id), { 
            nome: document.getElementById('m-nome').value, 
            senha: document.getElementById('m-senha').value, 
            cor: document.getElementById('m-cor').value, 
            logo: document.getElementById('m-logo').value 
        });
        alert("Salvo!"); listarClientes();
    };
    async function listarClientes() {
        const s = await getDocs(collection(db, "configuracoes_mestre"));
        let h = ""; s.forEach(d => h += `<div style="padding:10px; border-bottom:1px solid #eee;">${d.id} - ${d.data().nome} <button onclick="window.delM('${d.id}')" style="width:auto; padding:5px; background:red; color:white;">X</button></div>`);
        document.getElementById('m-lista').innerHTML = h;
    }
    window.delM = async (id) => { if(confirm("Excluir cliente?")) { await deleteDoc(doc(db, "configuracoes_mestre", id)); listarClientes(); }};

    setInterval(() => { document.getElementById('txt-time').innerText = new Date().toLocaleTimeString('pt-BR'); }, 1000);
    init();
</script>
</body>
</html>
